<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worldwide Dispatch Simulator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #0d1b2a;
            color: #e0e1dd;
        }
        
        header {
            background-color: #1b263b;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 320px;
            background-color: #415a77;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #map {
            flex: 1;
            z-index: 1;
        }
        
        .controls {
            padding: 1rem;
            background-color: #1b263b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section {
            background-color: #778da9;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .section-title {
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e1dd;
        }
        
        .resources {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .resource {
            text-align: center;
        }
        
        .resource-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        button {
            background-color: #e0e1dd;
            color: #0d1b2a;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0.2rem;
        }
        
        button:hover {
            background-color: #a9b6c5;
        }
        
        .buy-btn {
            background-color: #4caf50;
            color: white;
        }
        
        .buy-btn:hover {
            background-color: #3d8b40;
        }
        
        .mission-btn {
            background-color: #ff9800;
            color: white;
        }
        
        .mission-btn:hover {
            background-color: #e68a00;
        }
        
        .alliance-btn {
            background-color: #9c27b0;
            color: white;
        }
        
        .alliance-btn:hover {
            background-color: #7b1fa2;
        }
        
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background-color: #1b263b;
            border-radius: 4px;
        }
        
        .missions-container {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .mission {
            background-color: #1b263b;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
        }
        
        .mission-complete {
            border-left-color: #4caf50;
        }
        
        .country-selector {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .country-btn {
            padding: 0.8rem;
            font-weight: bold;
            width: 120px;
        }
        
        .selected {
            box-shadow: 0 0 0 3px #ff9800;
        }
        
        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            background-color: #1b263b;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }
        
        .vehicle {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            z-index: 500;
            transform: translate(-50%, -50%);
        }
        
        .building {
            position: absolute;
            width: 24px;
            height: 24px;
            z-index: 400;
            transform: translate(-50%, -50%);
        }
        
        .fire-station {
            background-color: #ff4d4d;
        }
        
        .police-station {
            background-color: #4d4dff;
        }
        
        .hospital {
            background-color: #4dff4d;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            background-color: #1b263b;
            border-left: 4px solid #ff9800;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* Alliance specific styles */
        .alliance-section {
            background-color: #5e35b1;
        }
        
        .alliance-members {
            max-height: 120px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }
        
        .member {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem;
            background-color: #7e57c2;
            border-radius: 4px;
            margin-bottom: 0.3rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #1b263b;
            padding: 2rem;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal h2 {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .modal input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            border: none;
            background-color: #e0e1dd;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .alliance-mission {
            border-left: 4px solid #9c27b0;
        }
        
        .online-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .online {
            background-color: #4caf50;
        }
        
        .offline {
            background-color: #f44336;
        }
        
        .chat-container {
            margin-top: 1rem;
            background-color: #1b263b;
            border-radius: 8px;
            padding: 0.5rem;
            max-height: 150px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .chat-input {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input input {
            flex: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: none;
            background-color: #e0e1dd;
        }
        
        .chat-message {
            margin-bottom: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background-color: #415a77;
        }
        
        .user-name {
            font-weight: bold;
            color: #ff9800;
        }
        
        .dispatcher-name {
            font-weight: bold;
            color: #4caf50;
        }
        
        .leader-name {
            font-weight: bold;
            color: #9c27b0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Worldwide Dispatch Simulator</h1>
        <p>Team up with other dispatchers to handle emergencies together</p>
    </header>
    
    <div class="container">
        <div class="sidebar">
            <div class="country-selector">
                <button id="australia-btn" class="country-btn selected">Australia</button>
                <button id="usa-btn" class="country-btn">USA</button>
            </div>
            
            <div class="resources">
                <div class="resource">
                    <div>Funds</div>
                    <div id="funds" class="resource-value">$50,000</div>
                </div>
                <div class="resource">
                    <div>Reputation</div>
                    <div id="reputation" class="resource-value">100</div>
                </div>
            </div>
            
            <div class="section alliance-section">
                <h3 class="section-title">Alliance: <span id="alliance-name">None</span></h3>
                <div id="alliance-actions">
                    <button onclick="showModal('create-alliance')" class="alliance-btn">Create Alliance</button>
                    <button onclick="showModal('join-alliance')" class="alliance-btn">Join Alliance</button>
                </div>
                <div id="alliance-info" style="display: none;">
                    <div>Members: <span id="member-count">1</span>/10</div>
                    <div>Shared Funds: $<span id="shared-funds">0</span></div>
                    <div class="alliance-members" id="members-list">
                        <!-- Members will be listed here -->
                    </div>
                    <button onclick="leaveAlliance()" class="alliance-btn">Leave Alliance</button>
                    
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <div class="chat-message"><span class="dispatcher-name">System:</span> Welcome to alliance chat!</div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chat-input" placeholder="Type message...">
                            <button onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Buy Vehicles</h3>
                <div class="item-list">
                    <div class="item">
                        <div>Fire Truck ($15,000)</div>
                        <button class="buy-btn" onclick="buyVehicle('fire-truck')">Buy</button>
                    </div>
                    <div class="item">
                        <div>Police Car ($12,000)</div>
                        <button class="buy-btn" onclick="buyVehicle('police-car')">Buy</button>
                    </div>
                    <div class="item">
                        <div>Ambulance ($10,000)</div>
                        <button class="buy-btn" onclick="buyVehicle('ambulance')">Buy</button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Buy Buildings</h3>
                <div class="item-list">
                    <div class="item">
                        <div>Fire Station ($30,000)</div>
                        <button class="buy-btn" onclick="buyBuilding('fire-station')">Buy</button>
                    </div>
                    <div class="item">
                        <div>Police Station ($25,000)</div>
                        <button class="buy-btn" onclick="buyBuilding('police-station')">Buy</button>
                    </div>
                    <div class="item">
                        <div>Hospital ($35,000)</div>
                        <button class="buy-btn" onclick="buyBuilding('hospital')">Buy</button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">Active Missions</h3>
                <div id="missions" class="missions-container">
                    <!-- Missions will be added here -->
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div id="map"></div>
            <div class="controls">
                <div class="timer">Next mission in: <span id="mission-timer">60</span>s</div>
                <button onclick="generateMission()" class="mission-btn">Generate Mission Now</button>
                <button onclick="generateAllianceMission()" class="alliance-btn">Alliance Mission</button>
            </div>
        </div>
    </div>
    
    <!-- Alliance Modals -->
    <div id="create-alliance" class="modal">
        <div class="modal-content">
            <h2>Create Alliance</h2>
            <input type="text" id="new-alliance-name" placeholder="Alliance Name">
            <input type="password" id="alliance-password" placeholder="Password (optional)">
            <div class="modal-buttons">
                <button onclick="createAlliance()">Create</button>
                <button onclick="hideModals()">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="join-alliance" class="modal">
        <div class="modal-content">
            <h2>Join Alliance</h2>
            <input type="text" id="join-alliance-name" placeholder="Alliance Name">
            <input type="password" id="join-password" placeholder="Password (if required)">
            <div class="modal-buttons">
                <button onclick="joinAlliance()">Join</button>
                <button onclick="hideModals()">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification">
        <div id="notification-text"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Game state
        const gameState = {
            funds: 50000,
            reputation: 100,
            country: 'australia',
            vehicles: [],
            buildings: [],
            missions: [],
            missionInterval: null,
            missionTimer: 60,
            vehicleCounter: 1,
            buildingCounter: 1,
            alliance: null,
            dispatcherName: generateDispatcherName(),
            onlineDispatchers: {},
            markers: []
        };

        // Generate a random dispatcher name
        function generateDispatcherName() {
            const prefixes = ['Alpha', 'Bravo', 'Charlie', 'Delta', 'Echo', 'Foxtrot', 'Gamma', 'Hotel'];
            const suffixes = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10'];
            return `${prefixes[Math.floor(Math.random() * prefixes.length)]}-${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
        }

        // Alliance data stored in localStorage
        let alliances = JSON.parse(localStorage.getItem('alliances')) || {
            'FirstResponders': { 
                name: 'FirstResponders', 
                password: null, 
                members: ['Alpha-01', 'Bravo-03'], 
                sharedFunds: 15000,
                owner: 'Alpha-01',
                chat: [{dispatcher: 'System', message: 'Alliance created!', time: new Date().toLocaleTimeString()}]
            },
            'RescueSquad': { 
                name: 'RescueSquad', 
                password: 'rescue', 
                members: ['Charlie-05'], 
                sharedFunds: 8000,
                owner: 'Charlie-05',
                chat: [{dispatcher: 'System', message: 'Alliance created!', time: new Date().toLocaleTimeString()}]
            }
        };

        // Map initialization
        const map = L.map('map').setView([-25.2744, 133.7751], 4); // Default to Australia
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Country coordinates
        const countryCoordinates = {
            australia: { center: [-25.2744, 133.7751], zoom: 4 },
            usa: { center: [37.0902, -95.7129], zoom: 4 }
        };
        
        // Mission types
        const missionTypes = [
            { type: 'Fire', requiredVehicle: 'fire-truck', baseReward: 5000, reputation: 5 },
            { type: 'Crime', requiredVehicle: 'police-car', baseReward: 4000, reputation: 3 },
            { type: 'Medical', requiredVehicle: 'ambulance', baseReward: 3000, reputation: 4 }
        ];
        
        // Alliance mission types (more challenging)
        const allianceMissionTypes = [
            { type: 'Major Fire', requiredVehicles: ['fire-truck', 'fire-truck', 'ambulance'], baseReward: 15000, reputation: 15 },
            { type: 'Terror Attack', requiredVehicles: ['police-car', 'police-car', 'ambulance', 'ambulance'], baseReward: 20000, reputation: 20 },
            { type: 'Natural Disaster', requiredVehicles: ['fire-truck', 'police-car', 'ambulance', 'ambulance'], baseReward: 25000, reputation: 25 }
        ];
        
        // Initialize the game
        function initGame() {
            updateUI();
            
            // Set up mission generation interval
            gameState.missionInterval = setInterval(() => {
                gameState.missionTimer--;
                document.getElementById('mission-timer').textContent = gameState.missionTimer;
                
                if (gameState.missionTimer <= 0) {
                    generateMission();
                    gameState.missionTimer = 60;
                }
            }, 1000);
            
            // Add some initial buildings
            addBuilding(-33.8688, 151.2093, 'fire-station');
            addBuilding(-33.8688, 151.3093, 'police-station');
            addBuilding(-33.8688, 151.4093, 'hospital');
            
            // Check if dispatcher was in an alliance previously
            const savedAlliance = localStorage.getItem('dispatcherAlliance');
            if (savedAlliance && alliances[savedAlliance]) {
                if (alliances[savedAlliance].members.includes(gameState.dispatcherName)) {
                    gameState.alliance = savedAlliance;
                    showNotification(`Rejoined alliance ${savedAlliance}`);
                }
            }
            
            // Simulate some online dispatchers
            simulateOnlineDispatchers();
            
            // Update UI
            updateUI();
            
            // Load alliance chat if in an alliance
            if (gameState.alliance) {
                loadAllianceChat();
            }
            
            // Show welcome message with dispatcher name
            showNotification(`Welcome, Dispatcher ${gameState.dispatcherName}`);
        }
        
        // Save alliances to localStorage
        function saveAlliances() {
            localStorage.setItem('alliances', JSON.stringify(alliances));
        }
        
        // Update UI with current game state
        function updateUI() {
            document.getElementById('funds').textContent = `$${gameState.funds.toLocaleString()}`;
            document.getElementById('reputation').textContent = gameState.reputation;
            
            // Update alliance info if in an alliance
            if (gameState.alliance) {
                const alliance = alliances[gameState.alliance];
                document.getElementById('alliance-name').textContent = alliance.name;
                document.getElementById('member-count').textContent = `${alliance.members.length}/10`;
                document.getElementById('shared-funds').textContent = alliance.sharedFunds.toLocaleString();
                
                // Update members list
                const membersList = document.getElementById('members-list');
                membersList.innerHTML = '';
                
                alliance.members.forEach(dispatcher => {
                    const memberElement = document.createElement('div');
                    memberElement.className = 'member';
                    
                    let nameClass = 'user-name';
                    if (dispatcher === alliance.owner) {
                        nameClass = 'leader-name';
                    } else if (dispatcher === gameState.dispatcherName) {
                        nameClass = 'dispatcher-name';
                    }
                    
                    memberElement.innerHTML = `
                        <span>
                            <span class="online-status ${gameState.onlineDispatchers[dispatcher] ? 'online' : 'offline'}"></span>
                            <span class="${nameClass}">${dispatcher}</span> ${dispatcher === alliance.owner ? '(Leader)' : ''}
                        </span>
                        <span>${dispatcher === gameState.dispatcherName ? 'You' : ''}</span>
                    `;
                    membersList.appendChild(memberElement);
                });
                
                // Show alliance info
                document.getElementById('alliance-actions').style.display = 'none';
                document.getElementById('alliance-info').style.display = 'block';
            } else {
                document.getElementById('alliance-name').textContent = 'None';
                document.getElementById('alliance-actions').style.display = 'block';
                document.getElementById('alliance-info').style.display = 'none';
            }
        }
        
        // Switch country
        document.getElementById('australia-btn').addEventListener('click', () => {
            switchCountry('australia');
        });
        
        document.getElementById('usa-btn').addEventListener('click', () => {
            switchCountry('usa');
        });
        
        function switchCountry(country) {
            gameState.country = country;
            const coords = countryCoordinates[country];
            map.setView(coords.center, coords.zoom);
            
            // Update button styles
            document.getElementById('australia-btn').classList.toggle('selected', country === 'australia');
            document.getElementById('usa-btn').classList.toggle('selected', country === 'usa');
            
            showNotification(`Switched to ${country === 'australia' ? 'Australia' : 'USA'}`);
        }
        
        // Buy a vehicle
        function buyVehicle(type) {
            const costs = {
                'fire-truck': 15000,
                'police-car': 12000,
                'ambulance': 10000
            };
            
            if (gameState.funds >= costs[type]) {
                gameState.funds -= costs[type];
                gameState.vehicles.push({
                    id: gameState.vehicleCounter++,
                    type: type,
                    available: true,
                    missionId: null
                });
                
                updateUI();
                showNotification(`Purchased a ${type.replace('-', ' ')}`);
            } else {
                showNotification("Not enough funds to buy this vehicle");
            }
        }
        
        // Buy a building
        function buyBuilding(type) {
            const costs = {
                'fire-station': 30000,
                'police-station': 25000,
                'hospital': 35000
            };
            
            if (gameState.funds >= costs[type]) {
                gameState.funds -= costs[type];
                
                // Get a random position in the current view
                const bounds = map.getBounds();
                const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                
                addBuilding(lat, lng, type);
                
                updateUI();
                showNotification(`Purchased a ${type.replace('-', ' ')}`);
            } else {
                showNotification("Not enough funds to buy this building");
            }
        }
        
        // Add a building to the map
        function addBuilding(lat, lng, type) {
            const building = {
                id: gameState.buildingCounter++,
                type: type,
                lat: lat,
                lng: lng
            };
            
            gameState.buildings.push(building);
            
            // Create marker
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: `building ${type}`,
                    iconSize: [24, 24]
                })
            }).addTo(map);
            
            // Add popup with building info
            marker.bindPopup(`<b>${type.replace('-', ' ')}</b><br>ID: ${building.id}`);
            
            // Store marker reference
            gameState.markers.push(marker);
        }
        
        // Generate a mission
        function generateMission() {
            const missionType = missionTypes[Math.floor(Math.random() * missionTypes.length)];
            
            // Get a random position in the current view
            const bounds = map.getBounds();
            const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
            const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
            
            const mission = {
                id: Date.now(),
                type: missionType.type,
                requiredVehicle: missionType.requiredVehicle,
                reward: missionType.baseReward + Math.floor(Math.random() * 2000),
                reputation: missionType.reputation,
                lat: lat,
                lng: lng,
                status: 'active', // active, in-progress, completed
                assignedVehicle: null,
                isAllianceMission: false
            };
            
            gameState.missions.push(mission);
            
            // Create marker for the mission
            const marker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <b>${mission.type} Emergency</b><br>
                Required: ${mission.requiredVehicle.replace('-', ' ')}<br>
                Reward: $${mission.reward}<br>
                <button onclick="assignVehicle(${mission.id})">Assign Vehicle</button>
            `);
            
            // Store marker reference
            gameState.markers.push(marker);
            
            // Add mission to UI
            const missionElement = document.createElement('div');
            missionElement.className = 'mission';
            missionElement.id = `mission-${mission.id}`;
            missionElement.innerHTML = `
                <b>${mission.type} Emergency</b><br>
                Required: ${mission.requiredVehicle.replace('-', ' ')}<br>
                Reward: $${mission.reward}
                <button onclick="assignVehicle(${mission.id})">Assign</button>
            `;
            
            document.getElementById('missions').appendChild(missionElement);
            
            showNotification(`New ${mission.type} emergency reported!`);
            
            gameState.missionTimer = 60;
            document.getElementById('mission-timer').textContent = gameState.missionTimer;
        }
        
        // Generate an alliance mission
        function generateAllianceMission() {
            if (!gameState.alliance) {
                showNotification("You need to be in an alliance to generate alliance missions!");
                return;
            }
            
            const missionType = allianceMissionTypes[Math.floor(Math.random() * allianceMissionTypes.length)];
            
            // Get a random position in the current view
            const bounds = map.getBounds();
            const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
            const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
            
            const mission = {
                id: Date.now(),
                type: missionType.type,
                requiredVehicles: missionType.requiredVehicles,
                reward: missionType.baseReward + Math.floor(Math.random() * 5000),
                reputation: missionType.reputation,
                lat: lat,
                lng: lng,
                status: 'active',
                assignedVehicles: [],
                isAllianceMission: true,
                contributors: []
            };
            
            gameState.missions.push(mission);
            
            // Create marker for the mission
            const marker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <b>ALLIANCE: ${mission.type}</b><br>
                Required: ${mission.requiredVehicles.join(', ').replace(/-/g, ' ')}<br>
                Reward: $${mission.reward}<br>
                <button onclick="assignVehicleToAllianceMission(${mission.id})">Assign Vehicle</button>
            `);
            
            // Store marker reference
            gameState.markers.push(marker);
            
            // Add mission to UI
            const missionElement = document.createElement('div');
            missionElement.className = 'mission alliance-mission';
            missionElement.id = `mission-${mission.id}`;
            missionElement.innerHTML = `
                <b>ALLIANCE: ${mission.type}</b><br>
                Required: ${mission.requiredVehicles.join(', ').replace(/-/g, ' ')}<br>
                Reward: $${mission.reward}
                <button onclick="assignVehicleToAllianceMission(${mission.id})">Assign</button>
            `;
            
            document.getElementById('missions').appendChild(missionElement);
            
            showNotification(`New alliance mission: ${mission.type}!`);
            
            // Add to alliance chat
            addChatMessage('System', `New alliance mission available: ${mission.type}`);
        }
        
        // Assign a vehicle to a mission
        function assignVehicle(missionId) {
            const mission = gameState.missions.find(m => m.id === missionId);
            if (!mission || mission.status !== 'active') return;
            
            // Find available vehicle of the required type
            const vehicle = gameState.vehicles.find(v => 
                v.type === mission.requiredVehicle && v.available
            );
            
            if (vehicle) {
                vehicle.available = false;
                vehicle.missionId = missionId;
                mission.status = 'in-progress';
                mission.assignedVehicle = vehicle.id;
                
                // Update mission UI
                const missionElement = document.getElementById(`mission-${missionId}`);
                missionElement.innerHTML = `
                    <b>${mission.type} Emergency</b><br>
                    Vehicle ${vehicle.id} en route<br>
                    <button onclick="completeMission(${missionId})">Complete</button>
                `;
                
                showNotification(`Vehicle ${vehicle.id} assigned to mission`);
            } else {
                showNotification(`No available ${mission.requiredVehicle.replace('-', ' ')} vehicles`);
            }
        }
        
        // Assign a vehicle to an alliance mission
        function assignVehicleToAllianceMission(missionId) {
            const mission = gameState.missions.find(m => m.id === missionId);
            if (!mission || mission.status !== 'active') return;
            
            // Find which vehicle types are still needed
            const neededVehicles = {};
            mission.requiredVehicles.forEach(v => {
                neededVehicles[v] = (neededVehicles[v] || 0) + 1;
            });
            
            mission.assignedVehicles.forEach(av => {
                neededVehicles[av.type] = (neededVehicles[av.type] || 1) - 1;
            });
            
            // Find an available vehicle of a needed type
            let vehicleToAssign = null;
            for (const type in neededVehicles) {
                if (neededVehicles[type] > 0) {
                    vehicleToAssign = gameState.vehicles.find(v => 
                        v.type === type && v.available
                    );
                    if (vehicleToAssign) break;
                }
            }
            
            if (vehicleToAssign) {
                vehicleToAssign.available = false;
                vehicleToAssign.missionId = missionId;
                
                mission.assignedVehicles.push({
                    id: vehicleToAssign.id,
                    type: vehicleToAssign.type,
                    dispatcher: gameState.dispatcherName
                });
                
                // Add dispatcher to contributors if not already there
                if (!mission.contributors.includes(gameState.dispatcherName)) {
                    mission.contributors.push(gameState.dispatcherName);
                }
                
                // Check if mission is now fully staffed
                if (mission.assignedVehicles.length >= mission.requiredVehicles.length) {
                    mission.status = 'in-progress';
                }
                
                // Update mission UI
                const missionElement = document.getElementById(`mission-${missionId}`);
                missionElement.innerHTML = `
                    <b>ALLIANCE: ${mission.type}</b><br>
                    Assigned: ${mission.assignedVehicles.length}/${mission.requiredVehicles.length}<br>
                    Your vehicles: ${mission.assignedVehicles.filter(av => av.dispatcher === gameState.dispatcherName).length}
                    <button onclick="completeAllianceMission(${missionId})">Complete</button>
                `;
                
                showNotification(`Vehicle ${vehicleToAssign.id} assigned to alliance mission`);
                
                // Add to alliance chat
                addChatMessage('System', `${gameState.dispatcherName} assigned a vehicle to alliance mission`);
            } else {
                showNotification("No available vehicles of needed types");
            }
        }
        
        // Complete a mission
        function completeMission(missionId) {
            const mission = gameState.missions.find(m => m.id === missionId);
            if (!mission || mission.status !== 'in-progress') return;
            
            const vehicle = gameState.vehicles.find(v => v.id === mission.assignedVehicle);
            if (vehicle) {
                vehicle.available = true;
                vehicle.missionId = null;
            }
            
            mission.status = 'completed';
            
            // Reward dispatcher
            gameState.funds += mission.reward;
            gameState.reputation += mission.reputation;
            
            // Update mission UI
            const missionElement = document.getElementById(`mission-${missionId}`);
            missionElement.classList.add('mission-complete');
            missionElement.innerHTML = `
                <b>${mission.type} Emergency</b><br>
                Completed! +$${mission.reward}<br>
                +${mission.reputation} Reputation
            `;
            
            // Remove mission marker from map
            removeMissionMarker(mission);
            
            updateUI();
            showNotification(`Mission completed! Reward: $${mission.reward}`);
            
            // Remove mission from list after a delay
            setTimeout(() => {
                missionElement.remove();
                gameState.missions = gameState.missions.filter(m => m.id !== missionId);
            }, 5000);
        }
        
        // Complete an alliance mission
        function completeAllianceMission(missionId) {
            const mission = gameState.missions.find(m => m.id === missionId);
            if (!mission || mission.status !== 'in-progress') return;
            
            // Return vehicles to their owners
            mission.assignedVehicles.forEach(av => {
                const vehicle = gameState.vehicles.find(v => v.id === av.id);
                if (vehicle) {
                    vehicle.available = true;
                    vehicle.missionId = null;
                }
            });
            
            mission.status = 'completed';
            
            // Calculate reward share
            const rewardShare = Math.floor(mission.reward / mission.contributors.length);
            const reputationShare = Math.floor(mission.reputation / mission.contributors.length);
            
            // Reward all contributors
            gameState.funds += rewardShare;
            gameState.reputation += reputationShare;
            
            // Add to alliance shared funds
            if (gameState.alliance) {
                const allianceSharedReward = Math.floor(mission.reward * 0.2); // 20% goes to shared funds
                alliances[gameState.alliance].sharedFunds += allianceSharedReward;
                saveAlliances();
            }
            
            // Update mission UI
            const missionElement = document.getElementById(`mission-${missionId}`);
            missionElement.classList.add('mission-complete');
            missionElement.innerHTML = `
                <b>ALLIANCE: ${mission.type}</b><br>
                Completed!<br>
                You received: $${rewardShare}<br>
                +${reputationShare} Reputation
            `;
            
            // Remove mission marker from map
            removeMissionMarker(mission);
            
            updateUI();
            showNotification(`Alliance mission completed! You received $${rewardShare}`);
            
            // Add to alliance chat
            addChatMessage('System', `Alliance mission completed! Contributors received $${rewardShare} each`);
            
            // Remove mission from list after a delay
            setTimeout(() => {
                missionElement.remove();
                gameState.missions = gameState.missions.filter(m => m.id !== missionId);
            }, 5000);
        }
        
        // Remove mission marker from map
        function removeMissionMarker(mission) {
            for (let i = gameState.markers.length - 1; i >= 0; i--) {
                const marker = gameState.markers[i];
                const latLng = marker.getLatLng();
                if (latLng.lat === mission.lat && latLng.lng === mission.lng) {
                    map.removeLayer(marker);
                    gameState.markers.splice(i, 1);
                    break;
                }
            }
        }
        
        // Alliance functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function hideModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        function createAlliance() {
            const name = document.getElementById('new-alliance-name').value;
            const password = document.getElementById('alliance-password').value;
            
            if (!name) {
                showNotification("Alliance name cannot be empty!");
                return;
            }
            
            if (alliances[name]) {
                showNotification("An alliance with that name already exists!");
                return;
            }
            
            // Create new alliance
            alliances[name] = {
                name: name,
                password: password || null,
                members: [gameState.dispatcherName],
                sharedFunds: 0,
                owner: gameState.dispatcherName,
                chat: [{dispatcher: 'System', message: 'Alliance created!', time: new Date().toLocaleTimeString()}]
            };
            
            gameState.alliance = name;
            localStorage.setItem('dispatcherAlliance', name);
            saveAlliances();
            
            hideModals();
            updateUI();
            loadAllianceChat();
            showNotification(`Alliance ${name} created!`);
        }
        
        function joinAlliance() {
            const name = document.getElementById('join-alliance-name').value;
            const password = document.getElementById('join-password').value;
            
            if (!alliances[name]) {
                showNotification("No alliance with that name exists!");
                return;
            }
            
            const alliance = alliances[name];
            
            if (alliance.password && alliance.password !== password) {
                showNotification("Incorrect password!");
                return;
            }
            
            if (alliance.members.length >= 10) {
                showNotification("This alliance is full!");
                return;
            }
            
            // Join alliance
            alliance.members.push(gameState.dispatcherName);
            gameState.alliance = name;
            localStorage.setItem('dispatcherAlliance', name);
            saveAlliances();
            
            // Add to alliance chat
            alliance.chat.push({
                dispatcher: 'System',
                message: `${gameState.dispatcherName} joined the alliance!`,
                time: new Date().toLocaleTimeString()
            });
            saveAlliances();
            
            hideModals();
            updateUI();
            loadAllianceChat();
            showNotification(`Joined alliance ${name}!`);
        }
        
        function leaveAlliance() {
            if (!gameState.alliance) return;
            
            const alliance = alliances[gameState.alliance];
            
            // Remove dispatcher from alliance
            alliance.members = alliance.members.filter(m => m !== gameState.dispatcherName);
            
            // Add to alliance chat
            alliance.chat.push({
                dispatcher: 'System',
                message: `${gameState.dispatcherName} left the alliance.`,
                time: new Date().toLocaleTimeString()
            });
            
            // If dispatcher was the owner, assign new owner or disband alliance
            if (alliance.owner === gameState.dispatcherName) {
                if (alliance.members.length > 0) {
                    alliance.owner = alliance.members[0];
                    showNotification(`Transferred ownership to ${alliance.members[0]}`);
                    
                    // Add to alliance chat
                    alliance.chat.push({
                        dispatcher: 'System',
                        message: `${alliance.members[0]} is now the alliance leader.`,
                        time: new Date().toLocaleTimeString()
                    });
                } else {
                    // Disband alliance if no members left
                    delete alliances[gameState.alliance];
                }
            }
            
            gameState.alliance = null;
            localStorage.removeItem('dispatcherAlliance');
            saveAlliances();
            
            updateUI();
            showNotification("Left the alliance");
        }
        
        // Chat functions
        function loadAllianceChat() {
            if (!gameState.alliance) return;
            
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            alliances[gameState.alliance].chat.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message';
                
                let nameClass = 'user-name';
                if (msg.dispatcher === 'System') {
                    nameClass = 'dispatcher-name';
                } else if (msg.dispatcher === alliances[gameState.alliance].owner) {
                    nameClass = 'leader-name';
                } else if (msg.dispatcher === gameState.dispatcherName) {
                    nameClass = 'dispatcher-name';
                }
                
                messageElement.innerHTML = `
                    <span class="${nameClass}">${msg.dispatcher}:</span> ${msg.message}
                    <span style="font-size: 0.7em; color: #a9b6c5;">${msg.time}</span>
                `;
                chatMessages.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addChatMessage(dispatcher, message) {
            if (!gameState.alliance) return;
            
            const chat = alliances[gameState.alliance].chat;
            chat.push({
                dispatcher: dispatcher,
                message: message,
                time: new Date().toLocaleTimeString()
            });
            
            // Keep chat to last 50 messages
            if (chat.length > 50) {
                alliances[gameState.alliance].chat = chat.slice(chat.length - 50);
            }
            
            saveAlliances();
            loadAllianceChat();
        }
        
        function sendChatMessage() {
            if (!gameState.alliance) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message) {
                addChatMessage(gameState.dispatcherName, message);
                input.value = '';
            }
        }
        
        // Handle Enter key in chat
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // Simulate online dispatchers for demo purposes
        function simulateOnlineDispatchers() {
            // Mark self as online
            gameState.onlineDispatchers[gameState.dispatcherName] = true;
            
            // Mark some sample dispatchers as online
            gameState.onlineDispatchers['Alpha-01'] = true;
            gameState.onlineDispatchers['Bravo-03'] = Math.random() > 0.5;
            gameState.onlineDispatchers['Charlie-05'] = Math.random() > 0.5;
            
            // Periodically update online status
            setInterval(() => {
                gameState.onlineDispatchers['Bravo-03'] = Math.random() > 0.3;
                gameState.onlineDispatchers['Charlie-05'] = Math.random() > 0.4;
                
                if (gameState.alliance) {
                    updateUI();
                }
            }, 10000);
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Initialize the game when the page loads
        window.onload = initGame;
    </script>
</body>
</html>