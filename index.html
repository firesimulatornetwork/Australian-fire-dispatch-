<!DOCTYPE html>
<html>
<head>
    <title>Australia Dispatch Simulator - Exploit Fix</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        /* --- SUMMER THEME CSS --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #F0E68C; /* Summer: Khaki/Sand color */
        }
        #main-container {
            display: flex;
            height: 100vh;
        }
        #mapid {
            flex-grow: 1;
        }
        #sidebar {
            width: 300px;
            background-color: #008080; /* Summer: Teal/Ocean color */
            color: white;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        h1 {
            color: #FFD700; /* Summer: Gold */
            margin-top: 0;
        }
        .info-panel {
            background-color: #006666; /* Darker Teal */
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .info-panel h2 {
            margin-top: 0;
            border-bottom: 2px solid #009999;
            padding-bottom: 5px;
            color: #fff;
        }
        .button-group button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #FF4500; /* Summer: Orange-Red */
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .button-group button:hover {
            background-color: #CC3700;
        }
        .mission-log {
            list-style-type: none;
            padding: 0;
            font-size: 14px;
        }
        .mission-log li {
            background-color: #007070;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
            user-select: none;
        }
        .mission-log li.vehicle-ready:hover {
            background-color: #009090;
            cursor: pointer;
        }
        .mission-log li.selected-vehicle {
            border: 2px solid gold;
            background-color: #004d99;
        }
        .rank-display {
            font-weight: bold;
            color: gold;
        }
        .double-money-alert {
            padding: 10px;
            background-color: #FFD700;
            color: black;
            text-align: center;
            font-weight: bold;
            border-radius: 5px;
            margin-bottom: 15px;
            animation: pulse 1.5s infinite alternate; 
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }
        #bp-rewards-list button {
            background-color: #00FF7F; /* Bright green for claim button */
            color: black;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-weight: bold;
        }
        #bp-rewards-list button:hover {
            background-color: #00CD66;
        }
    </style>
</head>
<body>

    <div id="main-container">
        <div id="mapid"></div>

        <div id="sidebar">
            
            <div class="double-money-alert" id="double-money-alert" style="display:none;">
                🎉 **DOUBLE MONEY EVENT IS LIVE!** 🎉
                <br>Time Remaining:
                <span id="double-money-timer" style="color:red; font-size:16px;"></span>
            </div>

            <div class="info-panel">
                <h2>🎯 Daily Challenges (v2.1.5)</h2>
                <p style="font-size: 12px; border-bottom: 1px dashed white; padding-bottom: 5px;">
                    Resets in: <span id="challenge-reset-timer" style="font-weight: bold; color: #FFD700;">Calculating...</span>
                </p>
                <ul id="challenges-list" class="mission-log" style="font-size: 14px; background-color: transparent;">
                    </ul>
            </div>
            
            <h1>Australia Dispatch</h1>
            <div class="info-panel">
                <h2>Game Status 📊</h2>
                <p>Funds: $<span id="funds">10000</span></p>
                <p>Rank: <span id="current-rank" class="rank-display">Trainee</span></p>
                <p>Missions Completed: <span id="missions-completed">0</span></p>
            </div>
            
            <div class="info-panel">
                <h2>Battle Pass 🌟</h2>
                <p>Level: <span id="bp-level" class="rank-display">1</span> / 25</p>
                <p>XP: <span id="bp-xp">0</span> / <span id="bp-xp-required">100</span></p>
                <div id="bp-progress-bar" style="height: 10px; background-color: #333; margin-top: 5px;">
                    <div id="bp-progress-fill" style="height: 100%; width: 0%; background-color: #FFD700; transition: width 0.3s;"></div>
                </div>
                <div style="margin-top: 10px;">
                    <h3>Upcoming Rewards:</h3>
                    <ul id="bp-rewards-list" class="mission-log" style="background-color: transparent;">
                        </ul>
                </div>
            </div>

            <div class="info-panel">
                <h2>Buy Assets 🛒</h2>
                <div class="button-group">
                    <button onclick="buyAsset('building', 5000, 'Fire Station')">Buy Fire Station ($5000)</button>
                    <button onclick="buyAsset('vehicle', 2000, 'Fire Truck')">Buy Fire Truck ($2000)</button>
                </div>
                <div class="button-group" style="margin-top: 15px; border-top: 1px dashed #fff; padding-top: 15px;">
                    <button onclick="buyAsset('building', 4000, 'Ambulance Station')" style="background-color: #1E90FF;">Buy Ambulance Station ($4000)</button>
                    <button onclick="buyAsset('vehicle', 1500, 'Ambulance')" style="background-color: #4682B4;">Buy Ambulance ($1500)</button>
                </div>
                <p style="font-size: 12px; margin-top: 10px;">*Vehicles must be purchased and placed near a Station.*</p>
            </div>

            <div class="info-panel">
                <h2>My Assets 🚒🚑</h2>
                <ul id="assets-list" class="mission-log">
                    </ul>
                <p style="font-size: 12px;">*Click a **Ready** vehicle to select it for dispatch.*</p>
            </div>
            
            <div class="info-panel">
                <h2>Active Missions 🚨</h2>
                <ul id="missions-list" class="mission-log">
                    </ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // --- Event Management (Timed Double Money Event) ---
        let DOUBLE_MONEY_END_TIME = 0; 
        let IS_DOUBLE_MONEY_ACTIVE = false; 
        // ---
        
        // --- Core Data: Battle Pass Rewards ---
        const BATTLE_PASS_REWARDS = [
            { level: 1, reward: { type: 'funds', amount: 500 }, description: '500 Funds' },
            { level: 2, reward: { type: 'funds', amount: 1000 }, description: '1,000 Funds' },
            { level: 3, reward: { type: 'funds', amount: 1500 }, description: '1,500 Funds' },
            { level: 5, reward: { type: 'funds', amount: 2500 }, description: '2,500 Funds' },
            { level: 10, reward: { type: 'funds', amount: 5000 }, description: '5,000 Funds (Mega Bonus!)' },
            { level: 15, reward: { type: 'funds', amount: 7500 }, description: '7,500 Funds (Huge Bonus!)' },
            { level: 20, reward: { type: 'funds', amount: 10000 }, description: '10,000 Funds (Epic Bonus!)' },
            { level: 25, reward: { type: 'funds', amount: 25000 }, description: '25,000 Funds (Max Level Reward!)' }, // FIXED
        ];
        
        // --- Core Data: Challenge Templates (NEW) ---
        const CHALLENGE_TEMPLATES = [
            { type: 'mission_count', target: 3, xpReward: 50, description: 'Complete 3 total Missions.' },
            { type: 'station_count', target: 2, xpReward: 75, description: 'Dispatch from 2 different Stations.' },
            { type: 'fire_mission', target: 1, xpReward: 60, description: 'Complete 1 Fire-related Mission.' },
            { type: 'hvp_mission', target: 1, xpReward: 100, description: 'Complete 1 High-Risk HVP Mission.' }
        ];


        // --- Game State and Core Data ---
        let game = {
            funds: 10000,
            missionsCompleted: 0,
            currentRank: 'Trainee',
            placingAsset: null,
            ownedAssets: [],
            activeMissions: [],
            assetIdCounter: 0,
            missionIdCounter: 0,
            pendingMission: null, 
            battlePass: { 
                level: 1,
                xp: 0,
                xpToNextLevel: 100,
                maxLevel: 25,
                rewardsClaimed: [],
                activeChallenges: [], 
                lastChallengeReset: 0, 
                usedStationsToday: [] 
            },
        };

        let selectedVehicle = null; 

        // --- ASSET TYPES (v2.1.9) ---
        const ASSET_TYPES = {
            'Fire Station': { cost: 5000, type: 'building', icon: 'red' },
            'Fire Truck': { cost: 2000, type: 'vehicle', icon: 'orange', specialties: ['Fire', 'Accident'] },
            'Ambulance Station': { cost: 4000, type: 'building', icon: 'lightgray' },
            'Ambulance': { cost: 1500, type: 'vehicle', icon: 'blue', specialties: ['Medical', 'Rescue', 'Accident'] }
        };

        const RANKS = [
            { name: 'Trainee', missions: 0 },
            { name: 'Communications Officer', missions: 5 },       
            { name: 'Senior Dispatcher', missions: 15 },
            { name: 'Watch Commander', missions: 30 },            
            { name: 'Chief Dispatch Coordinator', missions: 50 }, 
            { name: 'Director of Operations', missions: 75 }      
        ];

        const HVP_AREA = {
            minLat: -38.5, 
            maxLat: -35.0,
            minLon: 142.0,
            maxLon: 146.5
        };

        // --- Map Initialization ---
        const mymap = L.map('mapid').setView([-25.2744, 133.7751], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);


        // --- UI Update Functions ---
        function updateUI() {
            document.getElementById('funds').innerText = game.funds;
            document.getElementById('missions-completed').innerText = game.missionsCompleted;
            document.getElementById('current-rank').innerText = game.currentRank;
            
            const assetsList = document.getElementById('assets-list');
            assetsList.innerHTML = '';
            game.ownedAssets.forEach(asset => {
                const li = document.createElement('li');
                
                let statusText = asset.status || 'Ready';
                if (asset.type === 'vehicle') {
                    if (statusText === 'Ready') statusText = 'Ready at Base';
                    if (statusText === 'Dispatched') statusText = 'En Route to Mission...';
                    if (statusText === 'On Scene') statusText = 'On Scene - Working';
                    if (statusText === 'Traveling Home') statusText = 'Returning to Base...';
                } else {
                    statusText = 'Base';
                }
                
                let prefix = '';
                if (game.pendingMission && asset.status === 'Ready') {
                    // Check if the vehicle is appropriate for the pending mission (NEW LOGIC)
                    const missionType = game.pendingMission.type;
                    const specialties = ASSET_TYPES[asset.name].specialties || [];
                    
                    let isAppropriate = false;
                    // Check for general 'Accident' type
                    if (missionType.includes('Accident') && specialties.includes('Accident')) {
                        isAppropriate = true;
                    }
                    // Check for specific type matches (e.g., Fire, Medical, Rescue)
                    if (specialties.some(s => missionType.includes(s) && s !== 'Accident')) {
                        isAppropriate = true;
                    }

                    if (isAppropriate) {
                        prefix = '➡️ **DISPATCH:** ';
                    } else {
                        // Vehicle is not appropriate, skip dispatch prompt
                        prefix = '';
                    }
                }

                li.innerHTML = `${prefix} ${asset.name} (ID: ${asset.id}) - **${statusText}**`;
                
                // Vehicle selection logic
                if (asset.type === 'vehicle' && asset.status === 'Ready' && prefix.includes('DISPATCH')) {
                    li.classList.add('vehicle-ready');
                    
                    if (game.pendingMission) {
                        li.onclick = () => {
                            dispatchVehicle(asset, game.pendingMission);
                            game.pendingMission = null; 
                            updateUI();
                        };
                    } 
                    
                    if (selectedVehicle && selectedVehicle.id === asset.id) {
                        li.classList.add('selected-vehicle');
                    }
                }
                assetsList.appendChild(li);
            });

            const missionsList = document.getElementById('missions-list');
            missionsList.innerHTML = '';
            game.activeMissions.forEach(mission => {
                const li = document.createElement('li');
                const displayReward = IS_DOUBLE_MONEY_ACTIVE ? mission.reward * 2 : mission.reward;
                li.innerText = `${mission.type} ($${displayReward})`;
                missionsList.appendChild(li);
            });

            // --- Battle Pass UI Update ---
            const bp = game.battlePass;
            const progressPercentage = (bp.xpToNextLevel === Infinity) ? 100 : (bp.xp / bp.xpToNextLevel) * 100;

            document.getElementById('bp-level').innerText = bp.level;
            document.getElementById('bp-xp').innerText = (bp.xpToNextLevel === Infinity) ? 'MAX' : bp.xp;
            document.getElementById('bp-xp-required').innerText = (bp.xpToNextLevel === Infinity) ? 'MAX' : bp.xpToNextLevel;
            document.getElementById('bp-progress-fill').style.width = `${progressPercentage}%`;

            const rewardsList = document.getElementById('bp-rewards-list');
            rewardsList.innerHTML = '';

            const levelsToShow = 5; 
            const relevantRewards = BATTLE_PASS_REWARDS
                .filter(r => r.level >= bp.level || (r.level < bp.level && !bp.rewardsClaimed.includes(r.level)))
                .sort((a, b) => a.level - b.level); 

            let count = 0;
            relevantRewards.forEach(reward => {
                if (count >= levelsToShow && reward.level > bp.level) return;

                const li = document.createElement('li');
                let status;
                
                if (reward.level <= bp.level && !bp.rewardsClaimed.includes(reward.level)) {
                    status = `<button onclick="claimReward(${reward.level})">Claim</button>`;
                } else if (reward.level <= bp.level && bp.rewardsClaimed.includes(reward.level)) {
                    status = 'Claimed ✅';
                } else {
                    status = 'Locked';
                }
                
                li.innerHTML = `**Level ${reward.level}:** ${reward.description} - ${status}`;
                rewardsList.appendChild(li);
                if (reward.level >= bp.level) count++;
            });
            if (bp.level >= bp.maxLevel) {
                 rewardsList.innerHTML = '<li>**MAX LEVEL REACHED!**</li>'
            }
            
            // --- Daily Challenges UI Update ---
            const challengesList = document.getElementById('challenges-list');
            challengesList.innerHTML = '';

            game.battlePass.activeChallenges.forEach(challenge => {
                if (!challenge.type) return; // Skip corrupted/empty challenges

                const li = document.createElement('li');
                let status = challenge.completed ? '✅ COMPLETE' : `(${challenge.progress}/${challenge.target})`;
                let color = challenge.completed ? 'style="color: #00FF7F; font-weight: bold;"' : '';
                
                li.innerHTML = `<span ${color}>${challenge.description}</span>: **+${challenge.xpReward} XP** ${status}`;
                challengesList.appendChild(li);
            });

            if (game.battlePass.activeChallenges.length === 0) {
                challengesList.innerHTML = '<li>Loading challenges...</li>';
            }
        }
        
        // --- Movement Logic ---
        function moveMarker(marker, startLatLng, endLatLng, durationMS, onComplete) {
            let startTime = null;
            const distanceLat = endLatLng.lat - startLatLng.lat;
            const distanceLng = endLatLng.lng - startLatLng.lng;

            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                const percentage = progress / durationMS;

                if (percentage < 1) {
                    const newLat = startLatLng.lat + distanceLat * percentage;
                    const newLng = startLatLng.lng + distanceLng * percentage;
                    marker.setLatLng([newLat, newLng]);
                    requestAnimationFrame(animate);
                } else {
                    marker.setLatLng(endLatLng);
                    if (onComplete) onComplete();
                }
            }
            requestAnimationFrame(animate);
        }

        // --- Dispatch Logic ---
        function selectVehicle(vehicle) {
            // Function currently unused, replaced by direct dispatch via mission click
        }

        function dispatchVehicle(vehicle, mission) {
            // Find home station location
            const homeStation = game.ownedAssets.find(a => a.id === vehicle.homeStationId);
            if (!homeStation) {
                alert('Error: Vehicle has no assigned home station. Cannot dispatch.');
                vehicle.status = 'Ready'; 
                updateUI();
                return;
            }
            
            const missionLatLng = L.latLng(mission.location);
            const homeLatLng = L.latLng(homeStation.location);
            const vehicleStartLatLng = vehicle.marker.getLatLng();

            // Status and timing
            const travelDurationMS = 5000; // 5 seconds to travel
            const missionWorkDurationMS = 5000; // 5 seconds on scene

            // --- PHASE 1: TRAVEL TO MISSION ---
            vehicle.status = 'Dispatched';
            vehicle.marker.bindPopup(`**${vehicle.name}** - En Route to ${mission.type}`).openPopup(); 
            updateUI(); 

            moveMarker(vehicle.marker, vehicleStartLatLng, missionLatLng, travelDurationMS, () => {
                // Vehicle arrived at mission
                vehicle.status = 'On Scene';
                vehicle.marker.setPopupContent(`**${vehicle.name}** - On Scene at ${mission.type}`);
                updateUI();

                // --- PHASE 2: MISSION WORK ---
                setTimeout(() => {
                    // Mission work complete, reward granted
                    completeMission(mission, vehicle); 

                    // --- PHASE 3: TRAVEL BACK HOME ---
                    vehicle.status = 'Traveling Home';
                    vehicle.marker.setPopupContent(`**${vehicle.name}** - Returning to Base`);
                    updateUI();
                    
                    moveMarker(vehicle.marker, missionLatLng, homeLatLng, travelDurationMS, () => {
                        // Vehicle arrived home
                        vehicle.status = 'Ready';
                        vehicle.marker.setLatLng(homeLatLng);
                        vehicle.location = homeLatLng; // Update stored location
                        
                        // FIX: Reset popup content and close it correctly to ensure readiness
                        vehicle.marker.setPopupContent(`${vehicle.name} - Ready at Base`);
                        vehicle.marker.closePopup(); 
                        updateUI();
                    });

                }, missionWorkDurationMS); 
            });
        }

        // --- Purchase and Placement Logic ---
        function buyAsset(assetType, cost, name) {
            // Check if user is trying to buy a vehicle without a relevant station
            if (assetType === 'vehicle') {
                const requiredStationType = name.includes('Fire') ? 'Fire Station' : 'Ambulance Station';
                if (!game.ownedAssets.some(a => a.name === requiredStationType)) {
                    alert(`You must own an ${requiredStationType} before you can buy an ${name}!`);
                    return;
                }
            }
            if (game.placingAsset) {
                alert(`You are already placing a ${game.placingAsset.name}. Click on the map first!`);
                return;
            }
            if (game.funds >= cost) {
                game.funds -= cost;
                game.placingAsset = { name: name, type: assetType, cost: cost };
                alert(`Click on the map to place your new ${name}.`);
                updateUI();
            } else {
                alert('Not enough funds!');
            }
        }

        function placeAssetOnMap(latlng) {
            let homeStationId = null;

            if (game.placingAsset.type === 'vehicle') {
                const requiredStationName = game.placingAsset.name.includes('Fire') ? 'Fire Station' : 'Ambulance Station';
                
                // Find the nearest relevant station (building) to assign the vehicle
                let homeStation = null;
                let minDistance = Infinity;

                game.ownedAssets.filter(a => a.type === 'building' && a.name === requiredStationName).forEach(station => {
                    const stationLatLng = L.latLng(station.location);
                    const dist = stationLatLng.distanceTo(latlng); 
                    if (dist < minDistance) {
                        minDistance = dist;
                        homeStation = station;
                    }
                });
                
                if (homeStation) {
                    homeStationId = homeStation.id;
                } else {
                    alert(`Error: Must place vehicle near a purchased ${requiredStationName}.`);
                    game.funds += game.placingAsset.cost; // Refund if placement fails
                    game.placingAsset = null;
                    updateUI();
                    return;
                }
            }

            const newAsset = {
                id: game.assetIdCounter++,
                name: game.placingAsset.name,
                type: game.placingAsset.type,
                location: latlng,
                status: 'Ready', 
                homeStationId: homeStationId, // Link vehicle to its base
                marker: null
            };
            
            const assetInfo = ASSET_TYPES[newAsset.name];
            const marker = L.marker(latlng, { icon: L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${assetInfo.icon}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })}).addTo(mymap);
            marker.bindPopup(`${newAsset.name} - Ready`);
            newAsset.marker = marker;
            
            game.ownedAssets.push(newAsset);
            game.placingAsset = null;
            updateUI();
        }

        // --- Rank System Logic ---
        function checkRank() {
            let newRank = game.currentRank;
            for (let i = RANKS.length - 1; i >= 0; i--) {
                if (game.missionsCompleted >= RANKS[i].missions) {
                    newRank = RANKS[i].name;
                    break;
                }
            }
            if (newRank !== game.currentRank) {
                game.currentRank = newRank;
                alert(`⭐ PROMOTION! You've been promoted to ${game.currentRank}!`);
            }
        }

        // --- Mission Spawning ---
        function getRandomCoordinates() {
            const buildings = game.ownedAssets.filter(a => a.type === 'building');

            if (buildings.length === 0) {
                // Fallback: Spawn randomly across Australia if no buildings are owned
                const lat = -10 + Math.random() * (-40 - (-10));
                const lon = 113 + Math.random() * (153 - 113);
                return [lat, lon];
            }

            // Select a random owned building to anchor the mission location
            const randomBuilding = buildings[Math.floor(Math.random() * buildings.length)];
            const baseLat = randomBuilding.location.lat;
            const baseLng = randomBuilding.location.lng;

            // Define the local area radius (0.5 degrees, simulates town/local area)
            const spawnRadius = 0.5; 

            // Calculate random offset
            const offsetLat = (Math.random() * spawnRadius) - (spawnRadius / 2);
            const offsetLng = (Math.random() * spawnRadius) - (spawnRadius / 2);

            const newLat = baseLat + offsetLat;
            const newLng = baseLng + offsetLng;

            return [newLat, newLng];
        }

        function generateMission() {
            const standardMissionTypes = [
                "Car Accident", 
                "Structure Fire", 
                "Medical Emergency",
                "Beach Rescue", 
                "Lost Person in National Park"
            ];
            
            let missionType = standardMissionTypes[Math.floor(Math.random() * standardMissionTypes.length)];
            let location; 
            let reward = Math.floor(Math.random() * 500) + 250;
            let iconColor = 'red';

            // 20% chance for a high-value HVP Plantations mission
            if (Math.random() < 0.20) {
                const lat = HVP_AREA.minLat + Math.random() * (HVP_AREA.maxLat - HVP_AREA.minLat);
                const lon = HVP_AREA.minLon + Math.random() * (HVP_AREA.maxLon - HVP_AREA.minLon);
                
                location = [lat, lon];
                missionType = 'HVP Forest Fire (HIGH RISK)';
                reward = 1500;
                iconColor = 'black'; 
            } else {
                // Standard mission: Spawn near an owned building
                location = getRandomCoordinates(); 
            }
            
            // Set marker color based on mission type (NEW LOGIC)
            if (missionType.includes('Medical') || missionType.includes('Rescue')) {
                iconColor = 'blue';
            } else if (missionType.includes('Accident')) {
                iconColor = 'orange'; // Shared color
            } else if (missionType.includes('Fire')) {
                iconColor = 'red';
            }
            
            const mission = {
                id: game.missionIdCounter++, 
                type: missionType,
                location: location,
                reward: reward,
                marker: null
            };
            
            const marker = L.marker(mission.location, { icon: L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })}).addTo(mymap);
            marker.bindPopup(`<b>Mission:</b> ${mission.type}<br>Reward: $${mission.reward}<br>`);
            mission.marker = marker;
            
            // Click handler sets the pending mission
            marker.on('click', () => {
                // Check if already placing an asset (higher priority)
                if (game.placingAsset) {
                    alert('Finish placing your asset first.');
                    return;
                }
                
                // Set the pending mission and prompt user to select vehicle
                game.pendingMission = mission;
                alert(`Mission selected: ${mission.type}. Now, click an **appropriate Ready vehicle** in the "My Assets" list to dispatch.`);
                updateUI(); // This redraws the sidebar to show "CLICK TO DISPATCH"
            });

            game.activeMissions.push(mission);
            updateUI();
        }

        // --- Mission Completion ---
        function completeMission(mission, vehicle) {
            let reward = mission.reward;
            
            // 1. Apply Double Money Bonus
            if (IS_DOUBLE_MONEY_ACTIVE) {
                reward *= 2;
                alert(`BONUS: Reward doubled! ${vehicle.name} successfully handled ${mission.type} and earned $${reward}.`);
            } else {
                alert(`${vehicle.name} successfully handled ${mission.type} and earned $${reward}.`);
            }
            
            // 2. Update Game State
            game.funds += reward;
            game.missionsCompleted++;
            checkRank(); 
            
            // 3. Battle Pass XP Gain & Challenge Update
            gainBattlePassXP(10); // Grant 10 XP per mission completion
            updateChallenges(mission.type, vehicle.homeStationId); 
            
            // 4. Clean up Mission
            if (mission.marker && mymap.hasLayer(mission.marker)) {
                mymap.removeLayer(mission.marker);
            }
            game.activeMissions = game.activeMissions.filter(m => m.id !== mission.id); 
        }

        // --- Battle Pass Logic ---
        function gainBattlePassXP(xpAmount) {
            let bp = game.battlePass;

            if (bp.level >= bp.maxLevel) return;

            bp.xp += xpAmount;

            // Check for level ups
            while (bp.xp >= bp.xpToNextLevel && bp.level < bp.maxLevel) {
                bp.xp -= bp.xpToNextLevel; 
                bp.level++;
                
                // Dynamic XP Scaling (increase XP required by 20% each level)
                if (bp.level < bp.maxLevel) {
                    bp.xpToNextLevel = Math.round(bp.xpToNextLevel * 1.2);
                } else {
                    bp.xpToNextLevel = Infinity; // Max level reached
                }
                
                alert(`🎉 Battle Pass Level Up! You reached Level ${bp.level}!`);
            }
            updateUI();
        }

        function claimReward(level) {
            const bp = game.battlePass;
            const rewardItem = BATTLE_PASS_REWARDS.find(r => r.level === level);

            if (!rewardItem || level > bp.level || bp.rewardsClaimed.includes(level)) {
                alert("Cannot claim this reward yet or it is already claimed.");
                return;
            }

            if (rewardItem.reward.type === 'funds') {
                game.funds += rewardItem.reward.amount;
                alert(`Claimed Level ${level} reward: Received $${rewardItem.reward.amount} Funds!`);
            } 
            // Add logic for other reward types here

            bp.rewardsClaimed.push(level);
            updateUI();
            saveGame(); 
        }

        // --- Challenge Logic ---
        function resetDailyChallenges() {
            const today = new Date().toDateString();
            const lastResetDate = new Date(game.battlePass.lastChallengeReset).toDateString();
            
            // Check if a reset is needed (once per day)
            if (today !== lastResetDate) {
                game.battlePass.activeChallenges = [];
                game.battlePass.usedStationsToday = []; // Reset stations used daily
                
                // Select 3 unique random challenges
                const pool = [...CHALLENGE_TEMPLATES];
                for (let i = 0; i < 3 && pool.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    const template = pool.splice(randomIndex, 1)[0];
                    
                    game.battlePass.activeChallenges.push({
                        ...template,
                        progress: 0,
                        completed: false
                    });
                }
                
                game.battlePass.lastChallengeReset = Date.now();
                console.log('Daily challenges have been reset!');
                updateUI();
            }
        }

        function updateChallenges(missionType, dispatchedStationId) {
            let challengesUpdated = false;

            game.battlePass.activeChallenges.forEach(challenge => {
                if (challenge.completed) return;

                // 1. Check specific mission type completion
                if (challenge.type === 'fire_mission' && (missionType.includes('Fire') || missionType.includes('Structure'))) {
                    challenge.progress += 1;
                    challengesUpdated = true;
                } else if (challenge.type === 'hvp_mission' && missionType.includes('HVP')) {
                    challenge.progress += 1;
                    challengesUpdated = true;
                } 
                
                // 2. Check total mission count
                else if (challenge.type === 'mission_count') {
                    challenge.progress += 1;
                    challengesUpdated = true;
                }
                
                // 3. Check if completed
                if (!challenge.completed && challenge.progress >= challenge.target) {
                    challenge.completed = true;
                    alert(`⭐ Challenge Complete! Earned ${challenge.xpReward} XP!`);
                    gainBattlePassXP(challenge.xpReward); // Grant XP reward
                    challengesUpdated = true;
                }
            });
            
            // 4. Check dispatch station count 
            const stationChallenge = game.battlePass.activeChallenges.find(c => c.type === 'station_count');
            if (stationChallenge && !stationChallenge.completed) {
                if (dispatchedStationId && !game.battlePass.usedStationsToday.includes(dispatchedStationId)) {
                    game.battlePass.usedStationsToday.push(dispatchedStationId);
                    challengesUpdated = true;
                }
                
                stationChallenge.progress = game.battlePass.usedStationsToday.length;
                
                if (!stationChallenge.completed && stationChallenge.progress >= stationChallenge.target) {
                    stationChallenge.completed = true;
                    alert(`⭐ Challenge Complete! Earned ${stationChallenge.xpReward} XP!`);
                    gainBattlePassXP(stationChallenge.xpReward);
                    challengesUpdated = true;
                }
            }


            if (challengesUpdated) {
                updateUI();
            }
        }
        
        // --- Timer Logic (DOUBLE MONEY EVENT) ---
        
        function updateDoubleMoneyTimer() {
            const now = Date.now();
            const timeLeftMS = DOUBLE_MONEY_END_TIME - now; 
            const alertElement = document.getElementById('double-money-alert');
            const timerElement = document.getElementById('double-money-timer');

            if (timeLeftMS <= 0) {
                // Event ended - CRITICAL FIX: Save the actual end time for cooldown
                if (IS_DOUBLE_MONEY_ACTIVE) {
                    localStorage.setItem('lastDoubleMoneyEndTime', now.toString()); 
                }
                
                IS_DOUBLE_MONEY_ACTIVE = false;
                if (alertElement) {
                    alertElement.style.display = 'none'; 
                }
                if (timerElement) {
                     timerElement.innerText = '';
                }
                return;
            }

            // Event is active
            IS_DOUBLE_MONEY_ACTIVE = true;
            if (alertElement) {
                alertElement.style.display = 'block';
            }

            const minutes = Math.floor(timeLeftMS / (1000 * 60));
            const seconds = Math.floor((timeLeftMS % (1000 * 60)) / 1000);

            if (timerElement) {
                timerElement.innerText = `[${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}]`;
            }
        }


        function updateResetTimer() {
            const now = new Date();
            const lastReset = new Date(game.battlePass.lastChallengeReset);
            
            // Calculate the time until midnight (next reset)
            const nextReset = new Date(lastReset);
            nextReset.setDate(lastReset.getDate() + 1);
            nextReset.setHours(0, 0, 0, 0); // Set to midnight of the next day

            const timeLeftMS = nextReset.getTime() - now.getTime(); 
            
            if (timeLeftMS < 0 || isNaN(timeLeftMS)) {
                // Time has passed or error, reset now
                resetDailyChallenges();
                return; 
            }

            const hours = Math.floor(timeLeftMS / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeftMS % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeftMS % (1000 * 60)) / 1000);

            const timerElement = document.getElementById('challenge-reset-timer');
            if (timerElement) {
                timerElement.innerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // --- Auto Save/Load System ---
        function saveGame() {
            const savedState = {
                funds: game.funds,
                missionsCompleted: game.missionsCompleted,
                currentRank: game.currentRank,
                battlePass: game.battlePass, 
                // Save the current Double Money End Time (for a currently running event)
                doubleMoneyEndTime: DOUBLE_MONEY_END_TIME, 
                // Save status and homeStationId
                ownedAssets: game.ownedAssets.map(asset => ({
                    id: asset.id,
                    name: asset.name,
                    type: asset.type,
                    location: asset.location,
                    status: asset.status, 
                    homeStationId: asset.homeStationId 
                }))
            };
            localStorage.setItem('dispatchSimulatorState', JSON.stringify(savedState));
            console.log('Game saved automatically!');
        }

        function loadGame() {
            const savedStateString = localStorage.getItem('dispatchSimulatorState');
            if (savedStateString) {
                const savedState = JSON.parse(savedStateString);
                
                game.funds = savedState.funds || 10000;
                game.missionsCompleted = savedState.missionsCompleted || 0;
                game.currentRank = savedState.currentRank || 'Trainee'; 
                
                // Load Double Money End Time, or 0 if undefined
                DOUBLE_MONEY_END_TIME = savedState.doubleMoneyEndTime || 0; 

                // Recalculate counter based on loaded assets OR default to 0
                game.assetIdCounter = (savedState.ownedAssets && savedState.ownedAssets.length) ? 
                                       Math.max(...savedState.ownedAssets.map(a => a.id)) + 1 : 0; 
                game.ownedAssets = []; 

                // Load Battle Pass state
                if (savedState.battlePass) {
                    game.battlePass = savedState.battlePass;
                    if (!game.battlePass.activeChallenges) game.battlePass.activeChallenges = [];
                    if (!game.battlePass.lastChallengeReset) game.battlePass.lastChallengeReset = 0;
                    if (!game.battlePass.usedStationsToday) game.battlePass.usedStationsToday = [];
                }

                // Rebuild assets - FIX: Check for ownedAssets before attempting iteration
                if (savedState.ownedAssets) {
                    savedState.ownedAssets.forEach(assetData => {
                        const latlng = assetData.location;
                        const assetInfo = ASSET_TYPES[assetData.name];
                        if (!assetInfo) return; 
                        
                        const marker = L.marker(latlng, { icon: L.icon({
                            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${assetInfo.icon}.png`,
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })}).addTo(mymap);
                        
                        const initialStatus = assetData.status || 'Ready'; 
                        marker.bindPopup(`${assetData.name} - ${initialStatus}`);
                        
                        const newAsset = {
                            id: assetData.id,
                            name: assetData.name,
                            type: assetData.type,
                            location: latlng,
                            status: initialStatus, 
                            homeStationId: assetData.homeStationId || null, 
                            marker: marker
                        };
                        game.ownedAssets.push(newAsset);
                    });
                }
                console.log('Game loaded!');
            } else {
                console.log('No saved game found. Starting a new game.');
            }
        }

        // --- Main Event Listeners and Timers ---
        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            
            // CONSTANT: One hour in milliseconds (3,600,000 ms)
            const ONE_HOUR_MS = 60 * 60 * 1000;
            
            // CRITICAL RESTART LOGIC: Check if event is running, or if cooldown is needed
            if (DOUBLE_MONEY_END_TIME === 0 || DOUBLE_MONEY_END_TIME <= Date.now()) {
                 // The event is not currently running. Check if a cooldown is required.
                 const lastEndTime = localStorage.getItem('lastDoubleMoneyEndTime');
                 
                 // If there's no record OR the time since the last event ended is more than 1 hour
                 if (!lastEndTime || (Date.now() - parseInt(lastEndTime) > ONE_HOUR_MS)) {
                     // Start a fresh 4-minute event
                     DOUBLE_MONEY_END_TIME = Date.now() + (4 * 60 * 1000); 
                     localStorage.removeItem('lastDoubleMoneyEndTime'); // Clear the cooldown timestamp for the new run
                     console.log('Starting new 4-minute Double Money Event.');
                 } else {
                     // Event expired, and we are in the cooldown window (prevent restart)
                     DOUBLE_MONEY_END_TIME = 0; // Ensures updateDoubleMoneyTimer keeps it deactivated
                     IS_DOUBLE_MONEY_ACTIVE = false;
                     console.log('Double Money Event is on cooldown (1 hour).');
                 }
            } else {
                // Event is running, continuing from save.
                console.log('Continuing Double Money Event from save.');
            }
            
            // Start the Double Money timer update loop
            setInterval(updateDoubleMoneyTimer, 1000); 

            // Start daily challenges timers
            resetDailyChallenges(); // Initial check/reset for challenges
            setInterval(updateResetTimer, 1000); // Start challenge timer display
            
            updateUI(); // Final UI update
        });

        mymap.on('click', (e) => {
            if (game.placingAsset) {
                placeAssetOnMap(e.latlng);
            }
            // If user clicks map but not a mission, clear the pending mission
            else if (game.pendingMission) {
                game.pendingMission = null;
                alert('Dispatch selection cancelled.');
                updateUI();
            }
        });

        // Generate missions every minute (60000ms)
        setInterval(generateMission, 60000); 

        // Auto-save every 30 seconds (30000ms)
        setInterval(saveGame, 30000);
    </script>
</body>
</html>